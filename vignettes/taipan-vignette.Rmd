---
title: "Taipan Vignette"
author: "Stephanie Kobakian"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Taipan Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")
library(taipan)
```

The taipan web application was created to streamline the process of manually tagging images to create a training set. It results in a tidy data structure that is ready to use for analysis.
It allows users to provide information regarding entire images, and smaller regions within. It is a survey style tool, with questions being posed for each image and  area identified.


## Installation

You can install the development version from Github using:

```{r, eval = FALSE}
# install.packages("devtools")
devtools::install_github("srkob1/taipan")
```

The Taipan app has been designed to run locally with images stored within the working directory.


## Usage


### Images
 To provide images for the users to annotate, create a directory called `images`. An example directory has been provided, it contains a sample of images provided by Tennis Australia, they depict scenes from the Channel 7 broadcast of the Australian Open 2016.

### Questions
 The question lists should be provided in the style of the sample question list. Each question requires the choices available, the question type and whether there should be a specific default answer.


### Launch the Shiny App

The taipan Shiny App is integrated into the taipan pacakge, it can be deployed locally using the following command:

```{r, echo=TRUE, eval=FALSE}
require(taipan)
launchTaipan()
```

Note that the function call is empty, it can be run with no arguments provided if there are images in the `images` directory. 

The `questions` argument takes a question list. Utilised when the question list has been provided in the global environment, for example the default `questions = sampleQuestions` indicates the structure required of the list object. Also available when loading the package is `questions = tennisQuestions`, this will result in the app displaying questions regarding the faces and scenes of the tennis broadcast images.

When the app is first run the `loadCache = FALSE` argument is appropriate. If annotations have already been attempted and you would like to progress to the next image in the folder that has not been considered `loadCache = TRUE`should be used in the function call.
This requires a `cache.Rdata` object to be found in the working directory, if there is no object the app will proceed from the beginning of the image set.
The `cache.Rdata` object will be saved and accessible in the working directory after any use of the app.

The `images` argument does not need to be provided by a user. The object is automatically created as a list of the names of all images provided in the images folder.


## Image Information

When a new image is shown the questions will reset to the default values.
The selected answers are saved when either the `Previous Image`, `Next Image`, or `Save All Answers` buttons are clicked.


```{r, echo=FALSE, dpi=200, fig.cap="Taipan initial display"}
knitr::include_graphics("Taipan1imageInformation.png")
```

The answers will now be available in the `scene_answers` data frame in the global package environment, or also available in the cache file if the app or R session is terminated.

### Selection Information

The brush tool is used to highlight areas of interest, in the tennis example the areas selected contained faces.

When a new area is selected the question set changes to show the questions provided for areas, instead of the questions for the whole image.


```{r, echo=FALSE, dpi=200, fig.cap="Taipan application selection questions displayed when area is selected by brush."}
knitr::include_graphics("Taipan2selectionInformation.png")

```


To save the answers for the specific faces, click the `Save Selection Answers` button.
When saved, the image will reload and the faces that have been saved will be outlined in green. 


```{r, echo=FALSE, dpi=200,fig.cap="Taipan application previously annotated face highlighted by green box."}
knitr::include_graphics("Taipan3selectionInformation.png")
```


When a selection is made, and another area of the image is clicked before saving, the answers will not be saved. This can be used to intentionally redraw a selection without saving.

The answers for all selection questions, for all selections will now be available in the `selection_answers` data frame in the global package environment.


### Editing

It is possible to make changes to previously answered questions. To edit scene information, return to the desired image and change the previously selected answers by clicking on either the `Previous Image`, `Next Image` or `Save All Answers` buttons.

To edit selection information, double click within a green outlined square. This will turn the square red, and indicate the answers now chosen will be saved for the selected area.
 

```{r, echo=FALSE, dpi=280, fig.cap="Taipan application editing previously annotated face, highlighted by red box on face and around image."}
knitr::include_graphics("Taipan4editings.png")
```


## Accessing Data

All information recorded in the app is accessible after the app is exited.
The tidy format data frames can now be used for analysis.

The `scene_answers` data frame is arranged so that every row contains a single answer to a question regarding one of the images considered.
The question column is created such that each row is named according to the nested list the question belongs to, followed by an underscore and the name of the list item for the question. The following code loads previously recorded annotations for the Australian Open tennis images.


```{r, echo=TRUE, warning=FALSE, message=FALSE}
scene_answers <- read_csv("scene_answers.csv")
selection_answers <- read_csv("selection_answers.csv")
```

```{r, echo=FALSE}
scene_answers[1:3,-1] %>% as.data.frame()
```

These can be rearranged to a wide form data set using the following function:

```{r, eval=FALSE}
scene_answers %>% spread(question, answers)
```

A similar approach may be taken with the `selection_answers`

```{r, eval=FALSE}
selection_answers %>% spread(question, answers)
```

### Plotting data


```{r, echo = FALSE, fig.width = 7, fig.height = 4}
selection_answers %>% spread(question,answers) -> faces

# ggplot(data=faces) +
#    geom_bar(aes(x=selection_visorhat, fill = selection_detect)) + 
#   coord_flip() +
#   guides(fill = guide_legend(title="Person Captured")) +
#   theme(legend.position="bottom") +
#   labs(caption="") +
#   ylab("Amount of Faces") + xlab("Hat or Visor worn on face")
```


## Something new

### Images

Replace the example image set with your images by adding PNG, JPEG and BMP files to the `inst/images` folder in the taipan directory.

### Questions

To use the package two sets of questions have been provided.
The question lists have a specific format:

```{r, echo=TRUE, eval=FALSE}
sampleQuestions <- list(scene = list(Q1 = list(qType = "radio",
                                               label = "My First Question",
                                               choices = c("a", "b", "c"),
                                               selected = c("b")),
                                     Q2 = list(qType = "check",
                                               label = "My Second Question",
                                               choices = c("1", "2", "3"))),
                        selection = list(Q1 = list(qType = "check",
                                                   label = "My First Question",
                                                   choices = c("a", "b", "c")),
                                         Q2 = list(qType = "radio",
                                                   label = "My Second Question",
                                                   choices = c("1", "2", "3"))))
```



The first object in the outer list, `scene`, contains a list of questions regarding the entire image.
It is recommended the objects within this list are carefully named for identification and analysis, they will become the identifiers in the exported data sets, the first question in the list above will be identified as `scene_Q1`.

The second object in the outer list is the `selection` list. It is recommended these names are not changed. The selection list contains the questions asked about the smaller areas located within an image. The answers given may, and are expected to, differ for each selected area within an image. There is no limit to how many selections can be found within each image or `scene`.

The list for each individual question should at least contain the following named objects: `qType, label, choices`. The character string provided for `qType` should be the function name of the shiny question object to be produced. For simplicity, the functions `radioButtons()` and `checkboxGroupInput()` can also be produced using the strings `"radio"` and `"check"`. 

The second named list object for each question is `label`, this refers to the text of the question that will be displayed to those answering. This should contain one character string.

Choices should contain two or more options. They type of question will determine whether there is always an answer provided.
Choices should be provided as a vector containing character strings for each possible choice for the question. For example `choices = c("1", "2", "3")` will give the user three options to be selected.

The optional argument, `selected`, applies when a particular answer should be a default answer. This may be appropriate if the expected default is not desired, for example the first option provided to a radio buttons question is shown as the default, or there is no check box initially selected and the question should not have a null result. To provide a default answer, provide the list object `selected` followed by a vector containing a character string, `= c("b"))` will make the default answer "b".

